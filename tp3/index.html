<!DOCTYPE html>
<html>
<head>
	<title>Leaflet Quick Start Guide Example</title>
	<meta charset="utf-8" />

	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css" />
	<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.0/css/select2.min.css" rel="stylesheet" />	
	<link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
  
</head>
<body>

<div class="container" style="width:75%; float:left;">
	<div id="map" style="width: 100%; height: 700px"></div>
</div>

<div class="container" style="width:25%; float:right;">
	<h2>BÃºsqueda de lugares</h2>


	<div class="form-group">
	    <label for="mylat">Latitud:</label>
	    <input type="text" class="form-control" value="-34.59" id="mylat">

	    <label for="mylng">Longitud:</label>
	    <input type="text" class="form-control" value="-58.39" id="mylng">
	</div>

	<div class="form-group">
	    <label for="venueTypeSelect">Lugares:</label>
	    <select id="venueTypeSelect">
			<option value="restaurant">restaurant</option>
			<option value="gimnasio">gimnasio</option>
			<option value="supermercado">supermercado</option>
		</select>

	</div>
	<div class="form-group">
	    <label for="query">Texto libre:</label>
	    <input type="text" class="form-control" id="query">
	</div>
	
  	<button class="btn btn-default" onclick="drawMap();false;">
  		Buscar
  	</button>
</div>
	
	
	
	<script src="https://code.jquery.com/jquery-2.1.4.js"></script>
	<script src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.0/js/select2.min.js"></script>
	<script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
	<script>

		window.onload = loadEnviroment;

		function loadEnviroment(){
			//cargo selector
			$('#venueTypeSelect').select2();

			//busco mi localizacion de estar disponible
			initGeolocation();
		}

		function initGeolocation(){
		    if(navigator.geolocation)
		        navigator.geolocation.getCurrentPosition(handleGetCurrentPosition, onError);
		}

		function handleGetCurrentPosition(location){
		    var lat = location.coords.latitude;
		    var lng = location.coords.longitude;
		    $('#mylng').val(lng);
		    $('#mylat').val(lat);
		}
		function onError(){alert('La geolocalizacion esta descativada en tu equipo');}

		function findQueryFromSelect(){
			return $('#venueTypeSelect').val();
		}

		function findQueryFromFreeText(){
			return $('#query').val();
		}

		function hasFreeText(){
			return $.trim(findQueryFromFreeText()) != "";
		}

		function getQuery(){
			if(hasFreeText()){
				return findQueryFromFreeText();
			}else{
				return findQueryFromSelect();
			}
			
		}

		function findLocation(){
			return [$('#mylat').val(), $('#mylng').val()];
		}

		function drawMap(){

			var map = L.map('map').setView(findLocation(), 13);

			L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1Ijoic2NhbWlzYXkiLCJhIjoiY2lnbnpmcWJ1MDBlZ245a29paHUyaXhxdCJ9.QvMEJGT_ga3JaFnHW74IIQ', {
				maxZoom: 18,
				id: 'mapbox.streets'
			}).addTo(map);

			var query = getQuery();

			drawVenues(map,query);

		}

		function drawMarker(map, position, tittle, content, radix){
			L.circleMarker(position).addTo(map).setRadius(radix)
				.bindPopup("<b>"+tittle+"</b><br />"+content+".").openPopup();
		}

		function drawVenues(map, query){
			$.map(findVenues(query),
				function(aVenue){
					var radix = aVenue.share * 100;
					drawMarker(map, aVenue.location, aVenue.name, aVenue.address+" - "+aVenue.usersCount+" - "+aVenue.share*100+"%", radix);
				}			
			);
		}

		function findVenues(query){
			var url = "https://api.foursquare.com/v2/venues/search?client_id=RYBTHFPYMS44VDOB5U3P5JZNVETCBEO2ZTWIF5VHDCMKKEOS&client_secret=WV43Z4BKYQ0LFRKCHDII5SO1VT1RKG0504A5NFOLSA0AZDKU&v=20130815&ll=-34.59,-58.39&query="+query;
			var venues = new Array();
			$.ajax(
				{
				url: url, 
				async: false,
				success: function(result){
					        $.map(
								result.response.venues, 
								function(element){
									 venues.push(
										{'name':element.name,
										 'location':[element.location.lat, element.location.lng],
										 'address':element.location.address,
										 'usersCount':element.stats.usersCount,
										 'share':0
										}
									  );
								} 
							);
					    }
				});

			//sumo la cantidad de usuario de todos los venues
			var totalUsers = 0;
			$.map(venues, function(aVenue){
				totalUsers += aVenue.usersCount;
			});

			//calculo el porcentaje que le corresponde a cada venue
			$.map(venues, function(aVenue){
				aVenue.share = new Number(aVenue.usersCount/totalUsers).toFixed(2);;
			});

			return venues;
		}

	</script>
</body>
</html>

