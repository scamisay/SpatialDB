<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>Visualizacion de arbolado de CABA</title>
	<link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
</head>
<body>
	<div class="container">		
		<div class="jumbotron">
			<h1>Visualización del arbolado de CABA</h1>
			<p>El propósito de esta guia es mostrar un método para lograr visualizar la población de las principales especies arbóreas porteñas por barrio, teniendo como fuente de información los datos abiertos proporcionados por el censo de la ciudad</p>
		</div>

		<div class="container">
			<section class="row">
    			<h2>1) bajar datos ofrecidos por el gobierno de la ciudad</h2>
    			<p><a target="_blank" href="http://data.buenosaires.gob.ar/dataset/censo-arbolado/resource/0327e26a-7dc6-4782-87a8-eb87ea51b4be">arbolado-espacios-verdes.csv</a> y <a target="_blank" href="http://data.buenosaires.gob.ar/dataset/censo-arbolado/resource/0d9b7af1-a307-4405-bbad-09fede2018ba">censo-arbolado-2011.csv</a> son los archivos que vamos a utilizar</p>
    			<p>Estructura de archivos:</p>
    			<p><strong>arbolado-espacios-verdes(id_arbol; altura_tot; diametro; inclinacion; id_especie; nombre_comun; nombre_cientifico; tipo_follaje; espacio_verde; ubicacion; nombre_familia; nombre_gen; origen; coord_x; coord_y; lat; lon)</strong></p>
    			<p><strong>censo-arbolado-2011(nombre_barrio; codigo_manzana; alt_ini; alt_fin; calle; coord_x; coord_y; id_especie; nombre_familia; nombre_genero; nombre_cientifico; nombre_comun; tipo_follaje; origen; longitude; latitude; geometry)</strong></p>
			</section>

			<section class="row">
    			<h2>2) leer datos desde los archivos y migrarlos a PostgreSQL</h2>
    			<p>Usaremos <a target="_blank" href="https://es.wikipedia.org/wiki/QGIS">QGIS</a> para importar los CSVs que hemos bajado. Para lograr esto debemos crear una <em>Layer</em> por archivo. Vamos a <strong>Add Delimited Text Layer > Browse...</strong> elegimos nuestro archivo, en este caso <em>arbolado-espacios-verdes.csv</em>. Seleccionamos las opciones que aparecen en el siguiente thumbnail:</p>
    			<p><img src="img/2-importing_csv.png" class="img-thumbnail"/></p>
    			<p>Vale la pena destacar que usamos <em>";"</em> como delimitador de campos y que le indicamos a la herramienta que los campos <em>lon</em> y <em>lat</em> deberan ser tomado como <em>(x,y)</em> en el mapa respectivamente. Damos <strong>Ok</strong>, elegimos el sistema de referencias de coordenas <strong>EPSG:4326</strong>.</p>
    			<p><img src="img/2-map.png" class="img-thumbnail"/></p>
    			<p>Hacemos lo mismo para el otro archivo, con la salvedad de que esta vez se tomaran <em>longitude</em> y <em>latitude</em> para formar los puntos.</p>
    			<p>Ahora tenemos que migrar la información que tenemos en las capas a PostgreSQL. Para esto primero debemos crear una conexion con la base. Hacemos click en <strong>Add PostGIS Layers > New</strong> y elegimos nuestra base. En este caso elegi una que ya tengo, <em>spacial</em>. Es importante tener en cuenta que nuestra base debe tener el <em>plugin</em> <strong>postgis</strong>. Replicamos como en la siguiente imagen:</p>
    			<p><img src="img/2-connection_db.png" class="img-thumbnail"/></p>
    			<p>Ahora que tenemos nuestra conexión la usaremos para migrar cada una de nuestras campas a la base. Por cada capa se creará una tabla. Ir a <strong>Database > DB Manager > DB Manager</strong></p>
    			<p><img src="img/2-import_layer_to_db.png" class="img-thumbnail"/></p>
    			<p>Damos <strong>Ok</strong>, esperamos que QGIS termine de migrar la layer y luego controlamos en la base que se haya dado de alta la tabla con sus tuplas.</p>
    			<p><img src="img/2-imported.png" class="img-thumbnail"/></p>
    			<p>Podemos ver que se creó la tabla con el tipo de columna <strong>geometry</strong>, este tipo de dato es muy práctico para el uso de queries espaciales. Repetimos el mismo procedimiento para la otra layer.</p>
			</section>

			<section class="row">
    			<h2>3) crear una tabla unificando la información</h2>
    			<p>Hasta el momento contamos con la información que tenemos en dos tablas distintas. Esto es inconveniente por dos motivos, el primero es que es más complicado realizar queries y el segundo y más importante es que puede haber un mismo árbol cargado en ambas tablas.</p>
                <p>POr medio de la siguiente consulta llevaremos la informacion a una nueva tabla llamada <em>arboles</em></p>

                <pre>CREATE TABLE arboles AS
SELECT geom, nombre_comun
FROM "arbolado-espacios-verdes"
UNION
SELECT geom, nombre_comun
FROM "censo-arbolado-2011"</pre>

			</section>

            <section class="row">
                <h2>4) bajar límites de los barrios</h2>
                <p>Ahora bajamos <a target="_blank" href="http://data.buenosaires.gob.ar/dataset/barrios/resource/5a799833-f2ad-44df-beac-3f17f45d2c19">barrios.zip</a> que es un  <em>shape file</em> con información de los límites de los barrios</p>
                <p>Lo agregamos como Layer en QGIS con la opción <strong>Add Vector Layer</strong></p>
                <p><img src="img/4-barrios.png" class="img-thumbnail"/></p>
                <p>Ahora lo exportamos a POSTGRES</p>
            </section>

            <section class="row">
                <h2>5) cantidad de árboles y especies por barrio</h2>
                <P>Mediante la función ST_CONTAINS() logro relacionar aquellos árboles que están dentro de los límites de cada barrio.</P>
                <pre>SELECT bc.barrio, count(*) as cantidad, a.nombre_comun
FROM barrios bc, arboles a
WHERE ST_CONTAINS(bc.geom, a.geom)
GROUP BY bc.barrio, a.nombre_comun;</pre>

            </section>

            <section class="row">
                <h2>6) Averiguo cual es la especie con mayor población por barrio</h2>
                <p>Para esta consulta tenemos que usar un operador de POSTGRES llamado OVER(), el cuál nos permite quedarnos con los principales resultados obtenidos por un GROUP BY</p>
                <pre>select barrio, nombre_comun, cantidad,rownum from (
    select a.barrio, a.cantidad, a.nombre_comun, row_number() over (partition by a.barrio order by  a.cantidad desc) as rownum 
    from 

(select bc.barrio, count(*) as cantidad, a.nombre_comun
from barrios bc, arboles a
where st_contains(bc.geom, a.geom)
group by bc.barrio, a.nombre_comun
) a
                
 ) tmp
 where rownum &lt 2;</pre>
                <p><img src="img/6-barrios_agrupados.png" class="img-thumbnail"/></p>
                
            </section>

            <section class="row">
                <h2>7) Crear mapa temático</h2>
                <p>Ahora vamos a crear una tabla reporte basada en la consulta anterior para poder pasarla a QGIS, donde haremos nuestro mapa temático</p>
                <pre>create table reporte as
select barrio, nombre_comun, cantidad,rownum from (
    select a.barrio, a.cantidad, a.nombre_comun, row_number() over (partition by a.barrio order by  a.cantidad desc) as rownum 
    from 

(select bc.barrio, count(*) as cantidad, a.nombre_comun
from barrios bc, arboles a
where st_contains(bc.geom, a.geom)
group by bc.barrio, a.nombre_comun
) a
                
 ) tmp
 where rownum &lt 2;</pre>
                <p>Ahora agregamos las columnas cantidad y nombre_comun a la tabla barrios</p>
                <pre>alter table barrios add column nombre_comun character varying;
alter table barrios add column cantidad bigint;

update barrios set nombre_comun = r.nombre_comun, cantidad = r.cantidad from reporte r where r.barrio = barrios.barrio;</pre>
                <p>Finalmente en QGIS con el <strong>Add Postgis Layer</strong> agregamos la layer de barrios basada en la tabla barrios, le elegimos un estilo a la layer categorizada soble <em>nombre_comun</em> y terminamos agregando un label cagegorizado sobre <em>cantidad</em>.</p>
                <p><img src="img/7-mapa_finalizado.png" class="img-thumbnail"/></p>
                <p>Podemos concluir que el Fresno Americano es el árbol por excelencia de la ciudad.</p>
                
            </section>
            

		</div>

	</div>
	<script type="text/javascript" source="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css"></script>
</body>
</html>